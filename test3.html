<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Sensor Coverage AR – Manual Input with Cylinder</title>
  <!-- A-Frame Library -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #ui-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.6);
      color: #fff;
      border-radius: 4px;
      z-index: 9999;
    }
    #ui-panel div {
      margin-bottom: 6px;
    }
    #ui-panel label,
    #ui-panel input,
    #ui-panel select,
    #ui-panel button {
      margin: 4px;
    }
  </style>
</head>
<body>
<!-- UI Panel: Enter units, ceiling height, sensor X and Z coordinates -->
<div id="ui-panel">
  <div>
    <label for="unitSelect">Units:</label>
    <select id="unitSelect" onchange="populateHeightDropdown()">
      <option value="feet">Feet</option>
      <option value="meters">Meters</option>
    </select>
  </div>
  <div>
    <label for="heightSelect">Ceiling Height:</label>
    <select id="heightSelect"></select>
    <label for="heightInput">Or custom:</label>
    <input type="number" step="0.1" id="heightInput" placeholder="e.g., 9.0" style="width:80px;">
  </div>
  <div>
    <label for="sensorX">Sensor X:</label>
    <input type="number" step="0.1" id="sensorX" placeholder="e.g., 0">
    <label for="sensorZ">Sensor Z:</label>
    <input type="number" step="0.1" id="sensorZ" placeholder="e.g., 0">
  </div>
  <button onclick="updateCoverage()">Update Coverage</button>
  <div id="placementStatus"></div>
</div>

<!-- AR Scene anchored on the Hiro marker -->
<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
  <a-marker preset="hiro">
    <!-- Optional ground plane for reference -->
    <a-plane position="0 0 0" rotation="-90 0 0" width="10" height="10"
             material="color: #fff; opacity: 0.1; transparent: true"></a-plane>
    <!-- Coverage volume: a cylinder that will be scaled to become elliptical -->
    <a-cylinder
            id="coverageVolume"
            radius-top="0.05"
            radius-bottom="1"
            height="2.5"
            position="0 1.25 0"
            material="color: #00ff00; opacity: 0.4; side: double"
    ></a-cylinder>
    <!-- Sensor representation: red box with a "Sensor" label -->
    <a-box
            id="sensorBox"
            position="0 2.5 0"
            width="0.1"
            height="0.1"
            depth="0.1"
            material="color: #ff0000"
    >
      <a-text value="Sensor" align="center" color="#ff0000" position="0 0.2 0"></a-text>
    </a-box>
  </a-marker>
  <!-- Camera -->
  <a-entity camera look-controls></a-entity>
</a-scene>

<script>
  /***************************************************
   * Coverage Data & Helper Functions
   ***************************************************/
          // Example coverage data (in feet) from your sensor specs.
  const coverageDataFeet = [
            { height: 7.5, width: 7.7, length: 9.5 },
            { height: 8.2, width: 9.2, length: 11.4 },
            { height: 9.0, width: 10.0, length: 12.3 },
            { height: 9.5, width: 10.7, length: 13.4 },
            { height: 10.0, width: 11.3, length: 14.5 },
            { height: 11.0, width: 13.8, length: 15.2 }
          ];
  // Convert to meters (1 ft = 0.3048 m)
  const coverageDataMeters = coverageDataFeet.map(e => ({
    height: +(e.height * 0.3048).toFixed(2),
    width: +(e.width * 0.3048).toFixed(2),
    length: +(e.length * 0.3048).toFixed(2)
  }));

  const unitSelect = document.getElementById("unitSelect");
  const heightSelect = document.getElementById("heightSelect");
  const heightInput = document.getElementById("heightInput");

  // Populate the ceiling height dropdown with suggested values.
  function populateHeightDropdown() {
    heightSelect.innerHTML = "";
    const data = unitSelect.value === "feet" ? coverageDataFeet : coverageDataMeters;
    data.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e.height;
      opt.textContent = e.height + (unitSelect.value === "feet" ? " ft" : " m");
      heightSelect.appendChild(opt);
    });
  }
  populateHeightDropdown();

  // Find coverage dimensions based on the given ceiling height.
  function findCoverageDimensions(inputHeight, isFeet) {
    const data = isFeet ? coverageDataFeet : coverageDataMeters;
    let exact = data.find(d => d.height === inputHeight);
    if (exact) return { width: exact.width, length: exact.length };
    let closest = data.reduce((prev, curr) =>
            Math.abs(curr.height - inputHeight) < Math.abs(prev.height - inputHeight)
                    ? curr
                    : prev
    );
    return { width: closest.width, length: closest.length };
  }

  /***************************************************
   * Update Sensor & Coverage Area Display
   ***************************************************/
  function updateCoverage() {
    // Get sensor coordinates from manual input fields.
    const sensorX = parseFloat(document.getElementById("sensorX").value);
    const sensorZ = parseFloat(document.getElementById("sensorZ").value);
    if (isNaN(sensorX) || isNaN(sensorZ)) {
      alert("Please enter valid sensor X and Z coordinates.");
      return;
    }
    // Get ceiling height from dropdown or custom input.
    const isFeet = unitSelect.value === "feet";
    let chosenHeight = parseFloat(heightSelect.value);
    if (heightInput.value.trim() !== "") {
      chosenHeight = parseFloat(heightInput.value);
    }
    if (isNaN(chosenHeight)) {
      alert("Please enter a valid ceiling height.");
      return;
    }
    // Update the sensor box position.
    const sensorBox = document.getElementById("sensorBox");
    sensorBox.setAttribute("position", `${sensorX} ${chosenHeight} ${sensorZ}`);

    // Update the coverage volume.
    // We'll use an <a-cylinder> where:
    // - The height is the chosen ceiling height.
    // - Its position.y is set to chosenHeight/2 so its bottom touches the floor (y=0).
    // - We'll use a fixed radius-bottom of 1, then scale the cylinder in X and Z to achieve the desired elliptical shape.
    const coverageVolume = document.getElementById("coverageVolume");
    coverageVolume.setAttribute("height", chosenHeight);
    // Position the cylinder so that its base is at y=0.
    coverageVolume.setAttribute("position", `${sensorX} ${chosenHeight / 2} ${sensorZ}`);
    // Set the cylinder’s top radius (at the sensor) to 0.05.
    coverageVolume.setAttribute("radius-top", 0.05);
    // Use a default radius-bottom of 1.
    coverageVolume.setAttribute("radius-bottom", 1);
    // Look up the coverage dimensions.
    const { width, length } = findCoverageDimensions(chosenHeight, isFeet);
    // Scale the cylinder so that:
    //   scale.x = (width/2) and scale.z = (length/2)
    coverageVolume.setAttribute("scale", `${width / 2} 1 ${length / 2}`);

    // Update the status message.
    document.getElementById("placementStatus").textContent =
            `Sensor placed at (${sensorX.toFixed(2)}, ${sensorZ.toFixed(2)}) with height ${chosenHeight}`;
    console.log(`Sensor at (${sensorX}, ${sensorZ}) with height ${chosenHeight}`);
  }
</script>
</body>
</html>
