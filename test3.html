<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sensor Coverage AR Demo</title>
  <!-- A-Frame Library -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #ui-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px;
      background-color: rgba(0, 0, 0, 0.5);
      color: #fff;
      border-radius: 4px;
      z-index: 9999;
    }
    #ui-panel label,
    #ui-panel select,
    #ui-panel input {
      margin-right: 6px;
    }
    #ui-panel button {
      margin-top: 6px;
      padding: 6px 12px;
    }
  </style>
</head>
<body>
<!-- UI Panel -->
<div id="ui-panel">
  <div>
    <label for="unitSelect">Units:</label>
    <select id="unitSelect" onchange="populateHeightDropdown()">
      <option value="feet">Feet</option>
      <option value="meters">Meters</option>
    </select>
  </div>
  <div>
    <label for="heightSelect">Ceiling Height:</label>
    <select id="heightSelect">
      <!-- Options will be populated automatically -->
    </select>
  </div>
  <div>
    <label for="heightInput">Or enter custom:</label>
    <input type="number" step="0.1" id="heightInput" style="width:80px;" placeholder="e.g. 9.0" />
  </div>
  <button onclick="updateCoverage()">Update Coverage</button>
</div>

<!-- AR Scene -->
<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
  <!-- Marker-based AR using the "hiro" marker -->
  <a-marker preset="hiro" type="pattern">
    <!--
      Coverage Area Visualization:
      - We use an <a-plane> that is rotated to lie flat.
      - Its scale will be set so that X = coverage width and Z = coverage length.
    -->
    <a-plane
            id="coverageArea"
            position="0 0 0"
            rotation="-90 0 0"
            width="1"
            height="1"
            material="color: #00ff00; opacity: 0.4; side: double;"
    ></a-plane>
    <!-- Sensor Representation -->
    <a-box
            id="sensorBox"
            position="0 2.5 0"
            width="0.1"
            height="0.1"
            depth="0.1"
            material="color: #ff0000;"
    ></a-box>
  </a-marker>
  <!-- Camera -->
  <a-entity camera></a-entity>
</a-scene>

<script>
  /************************************************************
   * 1. COVERAGE TABLE
   *    - Example sensor coverage data.
   *    - Data is provided in feet; a converted version in meters is available.
   ************************************************************/
  const coverageDataFeet = [
    { height: 7.5, width: 7.7, length: 9.5 },
    { height: 8.2, width: 9.2, length: 11.4 },
    { height: 9.0, width: 10.0, length: 12.3 },
    { height: 9.5, width: 10.7, length: 13.4 },
    { height: 10.0, width: 11.3, length: 14.5 },
    { height: 11.0, width: 13.8, length: 15.2 }
  ];

  // Convert feet to meters (1 ft = 0.3048 m)
  const coverageDataMeters = coverageDataFeet.map(entry => ({
    height: +(entry.height * 0.3048).toFixed(2),
    width: +(entry.width * 0.3048).toFixed(2),
    length: +(entry.length * 0.3048).toFixed(2)
  }));

  /************************************************************
   * 2. POPULATE THE HEIGHT DROPDOWN
   ************************************************************/
  const unitSelect = document.getElementById('unitSelect');
  const heightSelect = document.getElementById('heightSelect');
  const heightInput = document.getElementById('heightInput');

  function populateHeightDropdown() {
    // Clear existing options
    heightSelect.innerHTML = '';
    // Select the appropriate data array based on chosen units
    const data = unitSelect.value === 'feet' ? coverageDataFeet : coverageDataMeters;
    data.forEach(entry => {
      const option = document.createElement('option');
      option.value = entry.height;
      option.textContent = `${entry.height} ${unitSelect.value === 'feet' ? 'ft' : 'm'}`;
      heightSelect.appendChild(option);
    });
  }

  // Initialize dropdown on load
  populateHeightDropdown();

  /************************************************************
   * 3. LOOKUP COVERAGE DIMENSIONS
   *    - Returns width and length based on the input height.
   *    - Uses an exact match if available; otherwise, picks the closest entry.
   ************************************************************/
  function findCoverageDimensions(inputHeight, isFeet) {
    const data = isFeet ? coverageDataFeet : coverageDataMeters;
    // Check for an exact match
    let exact = data.find(d => d.height === inputHeight);
    if (exact) return { width: exact.width, length: exact.length };

    // Find the nearest entry
    let closest = data.reduce((prev, curr) =>
            Math.abs(curr.height - inputHeight) < Math.abs(prev.height - inputHeight) ? curr : prev
    );
    return { width: closest.width, length: closest.length };
  }

  /************************************************************
   * 4. UPDATE COVERAGE FUNCTION
   ************************************************************/
  function updateCoverage() {
    const isFeet = unitSelect.value === 'feet';
    let chosenHeight = parseFloat(heightSelect.value);
    // If the custom input field is not empty, it overrides the dropdown.
    if (heightInput.value.trim() !== '') {
      chosenHeight = parseFloat(heightInput.value);
    }
    if (isNaN(chosenHeight)) {
      alert('Please enter a valid ceiling height.');
      return;
    }

    // Get the appropriate coverage dimensions from our table.
    const { width, length } = findCoverageDimensions(chosenHeight, isFeet);

    // Update the sensor box's vertical position.
    const sensorBox = document.getElementById('sensorBox');
    sensorBox.setAttribute('position', `0 ${chosenHeight} 0`);

    // Update the coverage area.
    // Here we use the plane's scale: X scale corresponds to width, Z scale to length.
    const coverageArea = document.getElementById('coverageArea');
    coverageArea.setAttribute('scale', `${width} 1 ${length}`);

    console.log(
            `Updated: Height = ${chosenHeight} ${isFeet ? 'ft' : 'm'}, Width = ${width}, Length = ${length}`
    );
  }
</script>
</body>
</html>
